# Sucoidownload 增强版 - 开发文档与计划 (YouTube 搜索与下载)

## 关键点 (Key Points)
- 开发一个增强版的视频批量下载工具，支持通过关键词搜索YouTube视频，并根据时长和排序筛选后批量下载。
- **架构设计:** 采用模块化设计，将 YouTube 相关逻辑（API交互、数据处理）封装在独立的 `youtube.py` 模块中，主程序 `sucoidownload.py` 负责 GUI 和通用下载流程控制，方便未来扩展支持其他平台。
- 使用 YouTube Data API 进行搜索，yt-dlp 进行下载，GUI 基于 Tkinter。
- 通过配置文件 (`config.json`) 管理 API Key 和默认下载路径，并提供设置界面。
- 开发计划包括实现筛选、分页、并行下载、进度条、取消功能等。

## 项目概览 (Project Overview)
本工具旨在提供一个图形化界面，让用户可以方便地搜索 YouTube 视频（未来可能扩展到其他平台），筛选结果，并将选中的视频添加到下载队列中进行批量下载。核心功能包括：
- **平台支持:** 初期重点支持 YouTube，架构设计考虑未来扩展。
- **搜索与筛选:** 支持关键词搜索，以及基于时长、排序等条件的筛选。
- **下载管理:** 提供下载列表，显示任务状态和进度，支持添加、移除任务。
- **配置化:** API Key 和下载路径等通过配置文件管理，并提供设置界面。

## 开发理由 (Development Rationale)
- **模块化架构:** 将平台特定逻辑（如 YouTube API 交互）分离到独立模块 (`youtube.py`)，降低耦合度，便于维护和未来扩展（如添加 Bilibili 支持）。主程序负责通用 GUI 和下载调度。
- **使用 YouTube Data API:** 合法高效获取元数据，支持动态搜索和筛选。
- **结合 yt-dlp 下载:** 通用且强大的视频下载库。
- **选择 Python 和 Tkinter:** 快速开发，跨平台，轻量级 GUI。
- **付费 API 选项:** 满足大规模操作需求。
- **配置管理:** 提高安全性和用户自定义能力。
- **本地保存:** 以视频标题和 ID 命名文件。

---

## 详细开发文档与计划

### 项目背景与目标
在现有批量 URL 下载工具的基础上，扩展实现平台化的视频搜索、筛选和下载功能。首期目标是完善 YouTube 平台的搜索下载流程，并建立可扩展的架构。

**核心目标:**
- 实现 YouTube 视频的关键词搜索与结果展示。
- 实现基于时长和排序的筛选功能。
- 实现将搜索结果添加到下载列表。
- 实现从下载列表启动批量下载，并更新状态。
- 将 YouTube 相关逻辑封装到 `youtube.py` 模块。
- 提供配置界面管理 API Key 和下载路径。
- (远期) 支持更多视频平台。

### 技术选型与实现原因

| 技术/工具         | 用途                                     | 原因                                                                 |
|-------------------|------------------------------------------|----------------------------------------------------------------------|
| Python            | 主要开发语言                             | 生态丰富，胶水特性强，适合快速开发。                                |
| Tkinter (`ttk`)   | GUI 界面                                 | 内置库，轻量，跨平台。使用 `ttk` 提供更现代的外观。                   |
| `sucoidownload.py`| 主程序入口，GUI 界面，通用下载逻辑         | 负责用户交互和整体流程控制。                                          |
| `youtube.py`      | YouTube 平台模块 (搜索、API 交互)         | 封装 YouTube 特定逻辑，实现平台解耦。                                |
| `config_manager.py`| 配置管理                                   | 封装配置读写逻辑。                                                   |
| JSON              | 配置文件格式                             | 易于人类阅读和机器解析。                                             |
| YouTube Data API  | YouTube 视频搜索与元数据获取             | 官方、合法、功能强大。                                               |
| `google-api-python-client` | Google API 客户端库                 | 方便调用 Google API。                                                |
| `isodate`         | 解析 ISO 8601 时长                       | 处理 YouTube API 返回的时长格式。                                     |
| yt-dlp            | 通用视频下载核心                         | 功能强大，支持广泛，已在项目中应用。                                |
| `threading`       | 后台执行耗时操作 (搜索、下载)            | 避免阻塞 GUI。                                                       |

### 架构设计 (新)
- **`sucoidownload.py` (主模块):**
    - 初始化 Tkinter GUI 界面。
    - 创建并管理所有 GUI 控件（窗口、按钮、表格等）。
    - 处理用户输入和按钮点击事件。
    - 调用 `ConfigManager` 加载/保存配置。
    - **调用特定平台模块 (如 `youtube.py`) 的接口执行搜索。**
    - 管理下载列表 (`download_tree`) 的数据。
    - **调用通用下载逻辑 (基于 yt-dlp)，并更新下载列表状态。**
    - 处理设置窗口逻辑。
- **`config_manager.py` (配置模块):**
    - 负责 `config.json` 的读写操作。
- **`youtube.py` (YouTube 平台模块):**
    - **封装 `search_videos` 函数，负责调用 YouTube Data API (`search.list`, `videos.list`)，处理 API 响应，返回结构化的视频信息列表。**
    - (未来可能) 封装与 YouTube 相关的其他功能。
- **(未来) `bilibili.py`, `tiktok.py` 等 (其他平台模块):**
    - 实现各自平台的搜索和元数据获取逻辑，提供与 `youtube.py` 类似的接口。

### 功能需求与设计
**GUI 设计 (v0.2.1):** (基本保持不变，但按钮事件的调用目标会改变)
- **顶部区域:** 状态栏, 搜索框, 操作按钮组 (搜索、添加、下载、设置)。
- **中部区域:** 搜索结果表格 (`search_tree`), 下载列表表格 (`download_tree`)。
- **底部区域:** 选择下载路径按钮, 保存路径输入框。

**设置窗口设计:** (保持不变)

**工作流程 (调整后):**
1.  **配置加载:** (不变)
2.  **搜索:**
    a. 用户输入关键词，点击“搜索视频”。
    b. `sucoidownload.py` 的 `handle_search` 调用 `youtube.py` 中的 `search_videos` 函数，传入关键词和 API Key (从 `ConfigManager` 获取)。
    c. `youtube.py` 执行 API 调用，处理数据，返回详细视频信息列表。
    d. `handle_search` 收到结果，更新 `search_tree` 表格和状态栏。
3.  **添加:** (不变) `add_selected_to_download` 将 `search_tree` 选中项添加到 `download_tree`。
4.  **下载:**
    a. 用户点击“开始下载”。
    b. `sucoidownload.py` 的 `start_download` 获取 `download_tree` 中待下载项的视频 ID。
    c. `start_download` **调用通用的下载函数 (`download_videos_from_tree`)**，传入视频 ID 列表和输出路径。
    d. 通用下载函数**根据视频 ID 构造 URL** (或未来根据平台获取下载信息)，调用 yt-dlp 下载，并通过回调 (`progress_hook`) 更新 `download_tree` 中的状态。
    e. (不变) 下载完成后弹窗总结。
5.  **设置:** (不变)

### 开发计划 (更新)

**当前阶段 (已完成):**
    - **代码重构**: 将 YouTube 平台相关的搜索和下载逻辑封装到独立的 `youtube.py` 模块，主程序 `sucoidownload.py` 通过接口和回调与其交互，实现解耦。
- 需求分析
- YouTube API 基础集成 (搜索与详情获取)
- 配置管理及设置界面
- 前端表格化重构与初步功能集成

**下一阶段 (代码重构 - 预计 1 天):**
| 优先级 | 任务描述                                                      | 负责人 | 产出物/验证标准                              | 状态     |
| :----- | :------------------------------------------------------------ | :----- | :------------------------------------------- | :------- |
| **主要** | **创建 `youtube.py` 模块:** 将 `search_videos` 逻辑移入。      | 全栈   | `youtube.py` 包含可独立测试的搜索函数。    | **待办** |
| **主要** | **修改 `sucoidownload.py`:** 调用 `youtube.search_videos`。    | 全栈   | 主程序通过调用模块实现搜索。                 | **待办** |
| **主要** | **(可选) 封装通用下载逻辑:** 考虑将 `download_videos_from_tree` 部分逻辑移到通用模块或保持在主程序中。 | 全栈   | 下载逻辑与平台搜索逻辑解耦。                | **待办** |
| 次要   | **更新文档:** 反映最终的重构结果。                            | 全栈   | 文档与代码结构一致。                         | **待办** |

**后续阶段 (按原计划):**
- **实现筛选功能** (GUI + 后端 `youtube.search_videos` 参数调整)
- **下载列表交互** (选择框、移除按钮)
- **用户体验改进** (进度条、取消按钮)
- **性能优化** (分页、并行下载)
- **测试与部署**

### 配置管理
(保持不变)

### 优化建议与改进方向
(将筛选功能移回收敛到“后续阶段”的计划中)

#### 用户体验改进
1.  **筛选选项：** (待办 - 下一阶段主要任务)
    - 问题：尚未实现时长和排序筛选。
    - 建议：在 GUI 添加下拉菜单，并在 `youtube.search_videos` 中加入处理筛选参数的逻辑。
    - 好处：满足用户精确查找的需求。
... (其他优化建议保持不变) ...

### 注意事项
(保持不变)

### 预期成果
(保持不变)

### 关键引用 (Key Citations)
(保持不变)
