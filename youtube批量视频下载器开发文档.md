# Sucoidownload 增强版 - 开发文档与计划 (YouTube 搜索与下载)

## 关键点 (Key Points)
- 我们将根据老板的新需求文档，开发一个增强版的视频批量下载工具，支持通过关键词搜索YouTube视频，并根据时长和排序筛选后批量下载。
- 工具将使用YouTube Data API进行搜索，结合现有yt-dlp进行下载，GUI基于Tkinter实现。
- 开发计划包括性能优化（如分页和并行下载）、用户体验改进（如进度条和取消功能）以及成本管理（如API配额监控）。
- **新增：** 通过配置文件 (`config.json`) 管理 API Key 和默认下载路径，并提供设置界面进行修改。

## 项目概览 (Project Overview)
我们将开发一个工具，允许用户输入关键词搜索YouTube视频，并通过时长（任意、短、中、长）和排序（相关性、上传时间、观看次数）筛选结果，然后批量下载到本地文件夹。工具将使用Google Cloud的YouTube Data API进行搜索，结合yt-dlp下载视频，GUI使用Python的Tkinter实现。通过配置文件管理 API Key 和默认下载路径，增强了安全性和灵活性。由于使用付费API，配额限制较宽松，适合批量操作。

## 开发理由 (Development Rationale)
- **使用YouTube Data API：** 目的是合法高效获取视频元数据，避免网页爬取的合规问题。API提供标准化接口，支持动态搜索和筛选。
- **结合yt-dlp下载：** API不直接支持下载，yt-dlp是高效的下载工具，适合批量操作。
- **选择Python和Tkinter：** Python集成性强，Tkinter轻量，无需额外依赖，适合快速开发简单GUI。
- **付费API：** 解除免费配额限制（10,000单位/天），支持更大规模操作。
- **本地保存：** 以视频标题和 ID 命名文件，便于用户管理并避免重名。
- **配置管理：** 使用 JSON 文件存储敏感信息（API Key）和用户偏好（下载路径），避免硬编码，提高安全性，方便用户修改。

---

## 详细开发文档与计划

### 项目背景与目标
当前，我们已有基于yt-dlp的视频批量下载工具，支持用户输入多个URL批量下载。我们需要根据老板的新需求，扩展功能为：
- 支持通过关键词搜索YouTube视频。
- 提供时长和排序筛选选项 (待实现)。
- 实现批量下载，并优化性能和用户体验。
- **新增：** 提供图形化界面来配置 API Key 和默认下载路径。

目标是创建一个简单易用的GUI工具，满足用户搜索、筛选和下载的需求，同时确保性能、安全性、易配置性和成本可控。

### 技术选型与实现原因
以下是技术选型的详细分析：

| 技术/工具         | 用途                       | 原因                                                                 |
|-------------------|----------------------------|----------------------------------------------------------------------|
| YouTube Data API  | 搜索和筛选视频             | 提供标准化接口，合法获取元数据，支持关键词搜索和筛选，减少合规风险。       |
| yt-dlp            | 视频下载                   | 高效批量下载工具，现有代码已集成，适合处理下载任务。                       |
| Python            | 后端逻辑和GUI开发          | 语言集成性强，社区支持广泛，适合快速开发。                                |
| Tkinter           | 简单GUI实现                | 轻量级，无需额外依赖，适合快速构建简单界面。                              |
| 付费API           | 解除配额限制               | 免费配额（10,000单位/天）不足以支持批量操作，付费API适合大规模使用。         |
| JSON / `config_manager.py` | 配置管理 (API Key, 路径) | 结构化存储配置，易于读写，避免硬编码敏感信息，提高安全性。               |

### 功能需求与设计
**当前 GUI 设计 (v0.2.1 - 布局调整后):**
- **顶部区域:**
  - 状态栏 (左): 显示当前操作状态。
  - 搜索关键词标签和输入框 (中)。
  - 操作按钮组 (右): 搜索视频、添加到下载列表、开始下载、设置。
- **中部区域:**
  - 搜索结果表格 (`ttk.Treeview`): 显示视频名称、播放量等详细信息。
  - 下载列表表格 (`ttk.Treeview`): 显示待下载/下载中/已完成的任务及状态。
- **底部区域:**
  - 选择下载路径按钮。
  - 保存路径输入框 (显示当前下载路径)。

**设置窗口设计:**
- **API Key 输入框：** 用于输入或修改 YouTube Data API Key，带占位符提示。
- **默认下载地址输入框：** 用于输入或修改默认下载路径，带占位符提示。
- **路径选择按钮 (`...`)：** 打开文件夹选择对话框以修改默认下载路径。
- **保存/取消按钮：** 保存更改或关闭窗口。

**工作流程 (v0.2.0):**
1.  **配置加载：** 程序启动时，加载 `config.json` 获取 API Key 和默认下载路径。若文件不存在，从 `config.example.json` 创建。若 Key 无效，弹窗提示。
2.  **搜索 (可选)：**
    a. 用户在“搜索关键词”框输入内容，点击“搜索视频”。
    b. 程序使用配置的 API Key 调用 YouTube Data API `search.list`。
    c. 获取到的视频 ID 转换为 URL，填充到下方的 URL 输入/结果框。
    d. 状态栏显示搜索结果数量或提示。
3.  **下载：**
    a. 用户确认 URL 输入/结果框中的 URL 列表。
    b. 用户确认或修改“保存路径”。
    c. 用户点击“开始下载”。
    d. 程序使用 yt-dlp 逐个下载列表中的视频到指定路径。
    e. 状态栏实时显示下载进度和当前文件名。
    f. 下载完成后，弹窗提示成功/失败数量。
4.  **设置 (可选)：**
    a. 用户点击“设置”按钮。
    b. 在弹出的设置窗口中修改 API Key 或默认下载路径。
    c. 点击“保存”，更改被写入 `config.json`，主程序状态（如 API Key）会相应更新。主窗口的下载路径显示也会根据新默认值进行智能更新。

### 开发计划
开发分以下阶段进行，预计时间为4周（从2025年3月27日起）：

| 阶段         | 任务描述                                     | 预计时间 | 负责人       | 状态 (截至 2025-03-28) |
|--------------|----------------------------------------------|----------|--------------|------------------------|
| 需求分析     | 确认需求细节，与产品经理讨论优先级             | 3天      | 开发团队     | 完成                   |
| **API集成**    | 集成YouTube Data API，测试搜索功能             | 1周      | 后端开发     | **部分完成 (基础搜索)** |
| **GUI开发**    | 基于Tkinter实现输入框、按钮和状态显示           | 1周      | 前端/全栈    | **部分完成 (搜索/设置)** |
| 配置管理     | 实现配置加载、保存、设置界面                   | (包含在GUI) | 全栈        | **完成**               |
| 性能优化     | 实现分页（nextPageToken）和并行下载           | 5天      | 后端开发     | 待办                   |
| 用户体验改进 | 添加进度条、取消按钮、筛选选项                  | 4天      | 前端/全栈    | 待办                   |
| 测试与部署   | 测试大批量下载（100+视频），修复Bug，部署工具 | 3天      | QA团队+开发团队 | 待办                   |

### 开发进展更新 (2025-03-28)
- **已完成：**
    - 集成 Google API Client 库。
    - 实现 `ConfigManager` 类和 JSON 配置文件 (`config.json`, `config.example.json`)，用于管理 API Key 和默认下载路径。
    - GUI 添加了关键词搜索框、搜索按钮、设置按钮。
    - 实现了基本的 YouTube 视频搜索功能（调用 `search.list`，结果填充 URL 框）。
    - 实现了设置窗口，允许用户查看和修改 API Key 及默认下载路径，支持占位符提示。
    - 反复调整按钮和控件布局以优化操作流程和视觉效果。
    - 配置更改可持久化保存到 `config.json`。
    - 优化了下载状态显示和错误处理。
- **待办：**
    - 实现搜索结果的筛选功能（时长、排序）。
    - 实现搜索结果分页加载。
    - 实现并行下载。
    - 实现下载进度条和取消功能。
    - 添加必要的错误处理和日志记录。
    - 进行大批量下载测试。

### 配置管理
- **`config.json`:** 存储用户的实际配置，程序启动时读取，设置保存时写入。**请勿将此文件提交到版本控制。**
- **`config.example.json`:** 配置文件的模板，包含所有必需的键和占位符说明。可安全提交到版本控制。
- **`config_manager.py`:** 包含 `ConfigManager` 类，封装了配置文件的加载、创建（从示例）、读取和保存逻辑。

**配置项:**
- `api_key`: 用户的 YouTube Data API v3 Key。
- `default_download_path`: 用户指定的默认视频保存路径（绝对路径）。如果为空，则使用程序根目录下的 `download` 文件夹。

### 优化建议与改进方向
以下是基于需求文档的优化建议：

#### 性能优化
1.  **分页支持：** (待办)
    - 问题：`search.list`一次最多返回50个结果。
    - 建议：使用`nextPageToken`实现分页，GUI添加“加载更多”按钮或自动分页。
    - 好处：提升批量下载能力，付费API高配额支持更多请求。
2.  **并行下载：** (待办)
    - 问题：当前逐个下载，速度慢。
    - 建议：使用Python的threading或multiprocessing并行下载。
    - 好处：缩短总下载时间，尤其在大批量时。

#### 用户体验改进
1.  **进度条或计数器：** (待办)
    - 问题：当前状态显示仅为文本，不够直观。
    - 建议：添加进度条（Tkinter的ttk.Progressbar）或显示“已下载X/Y”。
    - 好处：用户能清晰了解进度。
2.  **取消功能：** (待办)
    - 问题：下载开始后无法中断。
    - 建议：添加“停止”按钮，通过线程控制终止操作。
    - 好处：提升用户控制感。
3.  **筛选选项：** (待办)
    - 问题：尚未实现时长和排序筛选。
    - 建议：在 GUI 添加下拉菜单，并在 API 调用或结果处理中加入筛选逻辑。
    - 好处：满足用户精确查找的需求。

#### 功能扩展
1.  **下载格式选择：** (待办)
    - 问题：当前优先下载 MP4。
    - 建议：GUI添加下拉菜单（如MP4视频、MP3音频），调整yt-dlp参数。
    - 好处：满足不同需求（如仅需音频）。
2.  **保存路径自定义：** (**已实现**)
    - 通过主窗口的“选择路径”按钮更改当前下载路径。
    - 通过设置窗口修改并保存默认下载路径。

#### 配额与成本管理
1.  **配额监控：** (待办)
    - 问题：需避免超支。
    - 建议：记录API请求消耗（search.list约100单位，videos.list约1单位），GUI显示“已用配额”或日志记录。
    - 好处：帮助用户管理成本。
2.  **批量请求优化：** (待办 - 筛选时可能需要)
    - 问题：单独调用videos.list增加配额消耗。
    - 建议：一次性传入多个视频ID（最多50个），减少请求次数。
    - 好处：降低API调用成本。

#### 错误处理
1.  **异常捕获：** (**部分实现**)
    - 已添加基本的 API 调用和下载异常捕获，并在 GUI 或控制台显示错误信息。
    - 可进一步细化错误类型和用户提示。
2.  **重试机制：** (待办)
    - 问题：下载失败无重试。
    - 建议：为下载失败视频提供重试机制（如重试3次）。
    - 好处：提升下载成功率。

#### 法律与合规性
- 问题：下载可能违反YouTube条款。
- 建议：启动时弹窗提醒“仅限个人使用，遵守YouTube条款”，记录用户确认 (待办)。
- 好处：降低法律风险。

### 注意事项
- 测试大批量下载（100+视频）时的性能，确保程序稳定。
- 确保程序退出时清理临时线程或进程。
- 开发过程中与产品经理确认优先级和具体实现细节。

### 预期成果
完成后的工具将是一个功能齐全、性能优化的视频批量下载器，支持搜索、筛选和下载，满足用户批量操作需求，同时提供良好的用户体验和成本控制。

### 关键引用 (Key Citations)
- [YouTube Data API Overview](https://developers.google.com/youtube/v3/docs)
- [yt-dlp GitHub Repository](https://github.com/yt-dlp/yt-dlp)
- [Tkinter Documentation](https://docs.python.org/3/library/tkinter.html)
- [Google API Python Client Library](https://github.com/googleapis/google-api-python-client)
